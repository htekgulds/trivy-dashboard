import Namespaces from '@/components/Namespaces'
import ReportTable from '@/components/ReportTable'
import Stats from '@/components/Stats'
import useNamespaces from '@/components/hooks/useNamespaces'
import useVulnerabilityReports from '@/components/hooks/useVulnerabilityReports'
import { getSumOfVulnerabilityReports } from '@/components/util'
import { DEFAULT_NAMESPACE } from '@/src/config'
import { useRouter } from 'next/router'
import { useState } from 'react'

export default function Home () {
  const router = useRouter()
  const [selectedNamespace, setSelectedNamespace] = useState(DEFAULT_NAMESPACE)
  const { data: namespaces, isLoading: isNamespacesLoading } = useNamespaces()
  const { data: vulnerabilityReports, isLoading: isVulnerabilityReportsLoading } =
    useVulnerabilityReports(selectedNamespace)

  const vulnerabilitySum = getSumOfVulnerabilityReports(vulnerabilityReports)

  const handleNamespaceChange = e => {
    setSelectedNamespace(e.target.value)
  }

  const handleRowClick = i => e => {
    console.log('row click', i)
    router.push(`vulnerabilityreports/${i.metadata.name}`)
  }

  if (isNamespacesLoading || isVulnerabilityReportsLoading) {
    return (
      <div className='w-full text-center py-24'>
        <span className='loading loading-infinity loading-lg'></span>
      </div>
    )
  }

  return (
    <div className='container mx-auto'>
      <div className='flex items-center justify-between mb-10'>
        <Namespaces items={namespaces} onSelect={handleNamespaceChange} selectedItem={selectedNamespace} />
        <div>
          <Stats stats={vulnerabilitySum} />
        </div>
      </div>
      <div>
        <ReportTable reports={vulnerabilityReports} handleRowClick={handleRowClick} />
      </div>
    </div>
  )
}
