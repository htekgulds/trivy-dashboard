import Namespaces from '@/components/namespaces'
import Stats from '@/components/stats'
import ReportTable from '@/components/table'
import { DEFAULT_NAMESPACE, ReportTypes } from '@/src/config'
import { useQuery } from '@tanstack/react-query'
import axios from 'axios'
import { useRouter } from 'next/router'
import { useState } from 'react'

async function getNamespaces () {
  const res = await axios.get('/api/k8s/namespaces')

  return res.data
}

async function getTrivyVulnerabilityReports (ns) {
  const res = await axios.get('/api/trivy/reports', {
    params: { ns, type: ReportTypes.VULNERABILITY, limit: 1000 }
  })

  return res.data
}

export default function Home () {
  const router = useRouter()
  const [selectedNamespace, setSelectedNamespace] = useState(DEFAULT_NAMESPACE)

  const { data: namespaces, isLoading: isNamespacesLoading } = useQuery({
    queryKey: ['namespaces'],
    queryFn: getNamespaces
  })

  const { data: vulnerabilityReports, isLoading: isVulnerabilityReportsLoading } = useQuery({
    queryKey: ['trivyVulnerabilityReports', selectedNamespace],
    queryFn: () => getTrivyVulnerabilityReports(selectedNamespace)
  })

  const vulnerabilitySum = vulnerabilityReports?.items.reduce(
    (sum, item) => {
      const totalCount = sum.totalCount + Object.values(item.report.summary).reduce((counts, c) => counts + c, 0)
      console.log(totalCount)

      return {
        totalCount,
        ...Object.entries(item.report.summary).reduce(
          (obj, [key, value]) => ({
            ...obj,
            [key]: sum[key] + value
          }),
          {}
        )
      }
    },
    {
      criticalCount: 0,
      highCount: 0,
      mediumCount: 0,
      lowCount: 0,
      noneCount: 0,
      unknownCount: 0,
      totalCount: 0
    }
  )

  const handleNamespaceChange = e => {
    setSelectedNamespace(e.target.value)
  }

  const handleRowClick = i => e => {
    console.log('row click', i)
    router.push(`vulnerabilityreports/${i.metadata.name}`)
  }

  if (isNamespacesLoading || isVulnerabilityReportsLoading) {
    return (
      <div className='w-full text-center py-24'>
        <span className='loading loading-infinity loading-lg'></span>
      </div>
    )
  }

  return (
    <div className='container mx-auto'>
      <div className='flex items-center justify-between mb-10'>
        <Namespaces items={namespaces} onSelect={handleNamespaceChange} selectedItem={selectedNamespace} />
        <div>
          <Stats stats={vulnerabilitySum} />
        </div>
      </div>
      <div>
        <ReportTable reports={vulnerabilityReports} handleRowClick={handleRowClick} />
      </div>
    </div>
  )
}
